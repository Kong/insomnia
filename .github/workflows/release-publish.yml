name: Release Publish

on:
  workflow_dispatch:
    branch:
      version:
        required: true
        description: Release branch (e.g. release/2022.1.0 or release/2022.1.0-beta.0)

env:
  RELEASE_VERSION: ${{ github.event.inputs.version }}
  RELEASE_CORE_TAG: core@${{ github.event.inputs.version }}
  RELEASE_BRANCH: release/${{ github.event.inputs.version }}
  IS_PRERELEASE: ${{ contains(github.event.inputs.version, 'alpha') || contains(github.event.inputs.version, 'beta') }}

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch # Check out the release branch
        uses: actions/checkout@v2
        with:
          ref: ${{ env.RELEASE_BRANCH }}

      - name: Download artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          workflow: release-core-build.yml
          workflow_conclusion: success
          branch: ${{ env.RELEASE_BRANCH }} # Branch workflow ran on != branch the workflow created
          path: ./artifacts/

      - name: Create Tag and Release
        uses: avakar/tag-and-release@v1
        id: core_tag_and_release
        with:
          tag_name: ${{ env.RELEASE_CORE_TAG }}
          release_name: Insomnia ${{ env.RELEASE_VERSION }}
          prerelease: ${{ env.IS_PRERELEASE }}
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts to release
        uses: xresloader/upload-to-github-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          release_id: ${{ steps.core_tag_and_release.outputs.id }}
          tag_name: ${{ env.RELEASE_CORE_TAG }}
          file: "./artifacts/*-latest-artifacts/insomnia-app/**"
          prerelease: ${{ env.IS_PRERELEASE }}
          draft: false

      # - name: Create github release for Inso lib@ tag  # TODO
      # - name: Upload Inso artifacts to release  # TODO

      # - name: Publish npm packages

      - name: Upload .deb to pulp (stable only)
        if: ${{ env.IS_PRERELEASE == false }}
        uses: docker://kong/release-script:latest
        env:
          PULP_USERNAME: ${{ secrets.PULP_USERNAME }}
          PULP_PASSWORD: ${{ secrets.PULP_PASSWORD }}
          PULP_HOST: ${{ secrets.PULP_HOST }}
          DEB_FILE: artifacts/ubuntu-latest-artifacts/insomnia-app/dist/*.deb
        with:
          entrypoint: python3
          args: '/usr/src/code/main.py release --file ${{ env.DEB_FILE }} --dist-name ubuntu --dist-version focal --package-type insomnia --publish'

      - name: Upload to snapcraft (stable only)
        if: ${{ env.IS_PRERELEASE == false }}
        run: echo "TODO WIP"

      # - name: Publish beta/stable to Insomnia API
      # - name: Check if branch is mergeable
      # - name: Merge Git branch

      # - name: Trigger homebrew workflow
