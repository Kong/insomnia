name: Generate Changelog

on:
  push:
    branches:
      - 'release/**'
# TODO add workflow-dispatch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# TODO env version and env branch

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      # TODO:
      # if env.VERSION not set, set it from branch name
      # if env.version set (via workflow_dispatch) - setup branch name

      - name: Checkout branch
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version-file: '.nvmrc'

      - name: Get latest release for Changelog
        id: latest_release
        uses: pozetroninc/github-action-get-latest-release@master
        with:
          repository: ${{ github.repository }}

      - name: Run Changelog-generator script
        id: changelog
        shell: bash
        run: |
          npx @kong/changelog-generator generate \
            --owner ${OWNER} \
            --repo insomnia \
            --base ${{ steps.latest_release.outputs.release }} \
            --head ${HEAD} \
            --releaseName "${RELEASE_NAME}" > ./temp_changelog.out
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: filfreire
          HEAD: ${{ github.sha }}
          RELEASE_NAME: ${{ github.ref_name }}
          # TODO
          # replace release name with env.Version
          # that can come from push or workflow dispatch

          # TODO edit OWNER to use Kong

      - name: Debug Changelog text
        shell: bash
        run: |
          cat ./temp_changelog.out

      # TODO Find the PR of the release branch

      # TODO create/update comment with
      # CHANGELOG_TEXT on PR that has env.BRANCH
